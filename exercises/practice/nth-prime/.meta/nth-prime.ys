!yamlscript/v0

defn prime(number):
  nth gen-primes(): number - 1

defn- gen-primes():
  primes-step {}: 2

defn- primes-step(table d):
  if-let factors table.$d:
    recur:
      reduce _ dissoc(table d) factors:
        \(reinsert %1 d %2)
      inc: d
    lazy-seq:
      cons d:
        primes-step:
          assoc: table sqr(d) [d]
          inc: d

defn- reinsert(table n prime):
  update-in table [(prime + n)]: conj prime
